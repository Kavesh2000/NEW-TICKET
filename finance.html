<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Reconciliation Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="modern-ui.css">
    <style>[data-module]:not(.visible){display:none !important;}</style>
    <style>
        .badge-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background: #FEF08A; color: #000; }
        .status-investigation { background: #93C5FD; color: #000; }
        .status-awaiting-approval { background: #FBCFE8; color: #000; }
        .status-approved { background: #86EFAC; color: #000; }
        .status-rejected { background: #FCA5A5; color: #000; }
        .status-reconciled { background: #A78BFA; color: #fff; }

        .severity-high { color: #DC2626; font-weight: bold; }
        .severity-medium { color: #D97706; font-weight: bold; }
        .severity-low { color: #16A34A; font-weight: bold; }

        .case-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        .case-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #0F766E;
        }

        .approval-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }
        .approval-pending { background: #FEF08A; color: #000; }
        .approval-approved { background: #86EFAC; color: #000; }
        .approval-rejected { background: #FCA5A5; color: #000; }

        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #E5E7EB;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 16px;
            padding-bottom: 16px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -37px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0F766E;
            border: 2px solid white;
        }
        .timeline-item-time {
            font-size: 12px;
            color: #6B7280;
        }
        .timeline-item-action {
            font-weight: 600;
            color: #1F2937;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: #F3F4F6;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-button.active {
            background: white;
            color: #0F766E;
            border-bottom: 3px solid #0F766E;
        }

        .stat-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #0F766E;
        }
        .stat-label {
            font-size: 14px;
            color: #6B7280;
            margin-top: 8px;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>
    
    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-building"></i>
                <span>Onit MFB</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Core Modules</div>
                <a href="submit.html" class="nav-item" data-page="submit">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Submit Ticket</span>
                </a>
                <a href="tickets.html" class="nav-item" data-page="tickets">
                    <i class="fas fa-list"></i>
                    <span>View Tickets</span>
                </a>
            </div>
            
            <div class="nav-section" data-module="finance">
                <div class="nav-section-title">Finance</div>
                <a href="finance.html" class="nav-item active" data-page="finance" data-module="finance">
                    <i class="fas fa-chart-line"></i>
                    <span>Reconciliation</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="users.html" class="nav-item" data-page="users">
                    <i class="fas fa-users"></i>
                    <span>Users & Roles</span>
                </a>
                <a href="admin.html" class="nav-item" data-page="admin">
                    <i class="fas fa-cog"></i>
                    <span>Admin Panel</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Compliance</div>
                <a href="audit.html" class="nav-item" data-page="audit">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Audit & Compliance</span>
                </a>
                <a href="reports.html" class="nav-item" data-page="reports">
                    <i class="fas fa-file-chart-line"></i>
                    <span>Reports & Analytics</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <a href="config.html" class="nav-item" data-page="config">
                    <i class="fas fa-sliders-h"></i>
                    <span>Configuration</span>
                </a>
                <a href="notifications.html" class="nav-item" data-page="notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <button class="logout-btn" id="logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>
    
    <!-- Header -->
    <header id="header" class="header">
        <div class="header-left">
            <button id="hamburger" class="hamburger" title="Toggle Menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">Finance Reconciliation</h1>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">Department</div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="mainContent" class="main-content pb-20">
        <!-- Access Control -->
        <div id="accessDenied" class="hidden text-center py-12">
            <i class="fas fa-lock text-6xl text-red-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Access Denied</h2>
            <p class="text-gray-600">Finance Reconciliation is available for Finance and Admin departments only.</p>
            <p class="text-gray-600">For assistance, contact <a href="mailto:automation@maishabank.com" class="text-teal-600 hover:underline">automation@maishabank.com</a></p>
            <a href="system.html" class="mt-4 inline-block bg-teal-600 text-white px-6 py-2 rounded-lg">Back to Dashboard</a>
        </div>

        <div id="financeContent" class="hidden">
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-number" id="statPending">0</div>
                    <div class="stat-label">Pending Cases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statInvestigation">0</div>
                    <div class="stat-label">Under Investigation</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statAwaitingApproval">0</div>
                    <div class="stat-label">Awaiting Approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statApproved">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statReconciled">0</div>
                    <div class="stat-label">Reconciled</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 mb-8 flex-wrap">
                <button id="btnImportTransactions" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center gap-2">
                    <i class="fas fa-upload"></i> Import Transactions
                </button>
                <button id="btnNewCase" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Create Case
                </button>
                <button id="btnAutoDetect" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <i class="fas fa-search"></i> Auto-Detect Discrepancies
                </button>
            </div>

            <!-- Tabs -->
            <div class="mb-6">
                <button class="tab-button active" onclick="switchTab('tab-all-cases')">All Cases</button>
                <button class="tab-button" onclick="switchTab('tab-awaiting-me')">Awaiting My Action</button>
                <button class="tab-button" onclick="switchTab('tab-assigned')">Assigned to Me</button>
                <button class="tab-button" onclick="switchTab('tab-dashboard')">Dashboard</button>
            </div>

            <!-- All Cases Tab -->
            <div id="tab-all-cases" class="tab-content">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">All Reconciliation Cases</h3>
                        <input type="text" id="searchCases" placeholder="Search case ID..." class="px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="casesList"></div>
                </div>
            </div>

            <!-- Awaiting My Action Tab -->
            <div id="tab-awaiting-me" class="tab-content hidden">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-xl font-bold mb-4">Cases Awaiting Your Approval</h3>
                    <div id="awaitingMeList"></div>
                </div>
            </div>

            <!-- Assigned to Me Tab -->
            <div id="tab-assigned" class="tab-content hidden">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-xl font-bold mb-4">Cases Assigned to You</h3>
                    <div id="assignedToMeList"></div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content hidden">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-xl font-bold mb-6">Reconciliation Dashboard</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Aging Report -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-bold mb-4">Cases by Age</h4>
                            <table class="w-full text-sm">
                                <tr class="border-b">
                                    <td class="py-2">0-7 days</td>
                                    <td class="text-right font-bold" id="aging0-7">0</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">8-14 days</td>
                                    <td class="text-right font-bold" id="aging8-14">0</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">15-30 days</td>
                                    <td class="text-right font-bold" id="aging15-30">0</td>
                                </tr>
                                <tr>
                                    <td class="py-2">30+ days</td>
                                    <td class="text-right font-bold text-red-600" id="aging30plus">0</td>
                                </tr>
                            </table>
                        </div>

                        <!-- High Value Cases -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-bold mb-4">High Value Cases</h4>
                            <div id="highValueCases" class="space-y-2 text-sm">
                                <p class="text-gray-500">No high value cases</p>
                            </div>
                        </div>
                    </div>

                    <!-- Unreconciled Balance -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold mb-4">Unreconciled Balance by Source</h4>
                        <table class="w-full text-sm">
                            <tr class="border-b">
                                <th class="text-left py-2">Source</th>
                                <th class="text-right py-2">Amount</th>
                                <th class="text-right py-2">Count</th>
                            </tr>
                            <tr id="source-corebanking" class="border-b">
                                <td class="py-2">Core Banking</td>
                                <td class="text-right">₦0</td>
                                <td class="text-right">0</td>
                            </tr>
                            <tr id="source-pos" class="border-b">
                                <td class="py-2">POS</td>
                                <td class="text-right">₦0</td>
                                <td class="text-right">0</td>
                            </tr>
                            <tr id="source-atm" class="border-b">
                                <td class="py-2">ATM</td>
                                <td class="text-right">₦0</td>
                                <td class="text-right">0</td>
                            </tr>
                            <tr id="source-csv" class="border-b">
                                <td class="py-2">CSV Upload</td>
                                <td class="text-right">₦0</td>
                                <td class="text-right">0</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Case Detail Modal -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="caseModalTitle">Case Details</h2>
                <button onclick="closeCaseModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Case Info -->
            <div id="caseInfo" class="space-y-4 mb-6"></div>

            <!-- Investigation Notes -->
            <div class="mb-6" id="investigationSection" style="display: none;">
                <h3 class="font-bold mb-2">Investigation Notes</h3>
                <textarea id="investigationNotes" class="w-full p-3 border border-gray-300 rounded-lg mb-2" rows="4" placeholder="Add investigation notes..."></textarea>
                <button id="btnAddNote" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Note</button>
                <div id="notesList" class="mt-4 space-y-2"></div>
            </div>

            <!-- Adjustment Proposal -->
            <div class="mb-6" id="adjustmentSection" style="display: none;">
                <h3 class="font-bold mb-2">Adjustment Proposal</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Adjustment Amount</label>
                        <input type="number" id="adjustmentAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Adjustment Type</label>
                        <select id="adjustmentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="manual">Manual Adjustment</option>
                            <option value="system">System Calculated</option>
                            <option value="reversal">Reversal</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Justification</label>
                        <textarea id="adjustmentJustification" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Why is this adjustment needed?"></textarea>
                    </div>
                    <button id="btnSubmitAdjustment" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Submit Adjustment Proposal</button>
                </div>
                <div id="adjustmentsList" class="mt-4 space-y-2"></div>
            </div>

            <!-- Approval Workflow -->
            <div class="mb-6" id="approvalSection" style="display: none;">
                <h3 class="font-bold mb-3">Approval Workflow</h3>
                <div id="approvalStatus" class="space-y-2 mb-4"></div>
                <div id="approvalButtons" class="flex gap-2">
                    <button id="btnApprove" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" style="display: none;">
                        <i class="fas fa-check mr-2"></i> Approve
                    </button>
                    <button id="btnReject" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" style="display: none;">
                        <i class="fas fa-times mr-2"></i> Reject
                    </button>
                </div>
            </div>

            <!-- Audit Trail -->
            <div class="mb-6">
                <h3 class="font-bold mb-3">Audit Trail</h3>
                <div id="auditTrail" class="timeline"></div>
            </div>

            <!-- Close Button -->
            <div class="flex justify-end gap-2">
                <button onclick="closeCaseModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Import Transactions</h2>
                <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">Source System</label>
                    <select id="importSource" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select source</option>
                        <option value="core-banking">Core Banking System</option>
                        <option value="pos">POS System</option>
                        <option value="atm">ATM Network</option>
                        <option value="csv">CSV File Upload</option>
                    </select>
                </div>

                <div>
                    <label class="block font-medium mb-2">Date Range</label>
                    <div class="flex gap-2">
                        <input type="date" id="importStartDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                        <input type="date" id="importEndDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div id="csvUploadDiv" style="display: none;">
                    <label class="block font-medium mb-2">Upload CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>

                <div class="flex gap-2">
                    <button id="btnExecuteImport" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                        <i class="fas fa-check mr-2"></i> Import
                    </button>
                    <button onclick="closeImportModal()" class="flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer id="footer">
        <p>&copy; 2026 Onit Microfinance Bank. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
    <script src="script.js"></script>
    <script>
        // ===== FINANCE MODULE DATA =====
        let financeDb = {
            cases: [],
            nextCaseId: 1000,
            currentUser: null
        };

        // ===== INITIALIZATION =====
        window.addEventListener('DOMContentLoaded', function() {
            const userDept = localStorage.getItem('userDept');
            financeDb.currentUser = userDept;

            // Set user info
            document.getElementById('userName').textContent = 'User (' + userDept + ')';
            document.getElementById('userRole').textContent = userDept + ' Department';

            // Check access
            if (!hasModuleAccess('finance', 'read')) {
                document.getElementById('accessDenied').classList.remove('hidden');
                document.getElementById('financeContent').classList.add('hidden');
            } else {
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('financeContent').classList.remove('hidden');
                document.getElementById('financeContent').classList.add('visible');
                loadFinanceData();
                refreshDashboard();
            }

            setupEventListeners();
            setupSidebar();
        });

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('btnImportTransactions').addEventListener('click', showImportModal);
            document.getElementById('btnNewCase').addEventListener('click', showNewCaseModal);
            document.getElementById('btnAutoDetect').addEventListener('click', autoDetectDiscrepancies);
            document.getElementById('importSource').addEventListener('change', handleSourceChange);
            document.getElementById('btnExecuteImport').addEventListener('click', executeImport);
            document.getElementById('btnAddNote').addEventListener('click', addInvestigationNote);
            document.getElementById('btnSubmitAdjustment').addEventListener('click', submitAdjustment);
            document.getElementById('btnApprove').addEventListener('click', approveCase);
            document.getElementById('btnReject').addEventListener('click', rejectCase);
            document.getElementById('searchCases').addEventListener('input', filterCases);
        }

        // ===== SIDEBAR & NAVIGATION =====
        function setupSidebar() {
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');
            const footer = document.getElementById('footer');
            const overlay = document.getElementById('overlay');

            hamburger.addEventListener('click', function() {
                sidebar.classList.toggle('closed');
                header.classList.toggle('expanded');
                mainContent.classList.toggle('expanded');
                footer.classList.toggle('expanded');
                overlay.classList.toggle('active');
            });

            overlay.addEventListener('click', function() {
                sidebar.classList.add('closed');
                header.classList.remove('expanded');
                mainContent.classList.remove('expanded');
                footer.classList.remove('expanded');
                overlay.classList.remove('active');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.add('closed');
                        header.classList.remove('expanded');
                        mainContent.classList.remove('expanded');
                        footer.classList.remove('expanded');
                        overlay.classList.remove('active');
                    }
                });
            });

            document.getElementById('logout').addEventListener('click', function() {
                localStorage.removeItem('userDept');
                window.location.href = 'index.html';
            });
        }

        // ===== CASE MANAGEMENT =====
        class ReconciliationCase {
            constructor() {
                this.caseId = 'REC-' + (financeDb.nextCaseId++);
                this.createdDate = new Date();
                this.status = 'pending';
                this.source = '';
                this.description = '';
                this.amount = 0;
                this.severity = 'low';
                this.assignedTo = null;
                this.investigationNotes = [];
                this.adjustmentProposals = [];
                this.approvals = {};
                this.auditTrail = [];
                this.addAuditEntry('Case created', financeDb.currentUser);
            }

            addAuditEntry(action, user, details = '') {
                this.auditTrail.push({
                    timestamp: new Date(),
                    action: action,
                    user: user,
                    details: details
                });
            }
        }

        function showNewCaseModal() {
            const dept = financeDb.currentUser;
            if (dept !== 'Finance' && dept !== 'admin') return;

            const source = prompt('Enter source system (core-banking/pos/atm/csv):');
            if (!source) return;

            const description = prompt('Enter case description:');
            if (!description) return;

            const amount = prompt('Enter discrepancy amount:');
            if (!amount) return;

            const newCase = new ReconciliationCase();
            newCase.source = source;
            newCase.description = description;
            newCase.amount = parseFloat(amount);
            newCase.severity = newCase.amount > 100000 ? 'high' : newCase.amount > 10000 ? 'medium' : 'low';
            newCase.assignedTo = dept;

            financeDb.cases.push(newCase);
            saveFinanceData();
            refreshDashboard();
            alert('Case ' + newCase.caseId + ' created successfully!');
        }

        function showCaseDetail(caseId) {
            const reconcileCase = financeDb.cases.find(c => c.caseId === caseId);
            if (!reconcileCase) return;

            const modal = document.getElementById('caseModal');
            document.getElementById('caseModalTitle').textContent = 'Case: ' + reconcileCase.caseId;

            const infoHtml = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-600">Case ID</label>
                        <p class="font-bold">${reconcileCase.caseId}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Status</label>
                        <p><span class="badge-status status-${reconcileCase.status}">${reconcileCase.status}</span></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Source</label>
                        <p class="font-bold">${reconcileCase.source}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Severity</label>
                        <p><span class="severity-${reconcileCase.severity}">${reconcileCase.severity.toUpperCase()}</span></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Amount</label>
                        <p class="font-bold">₦${reconcileCase.amount.toLocaleString()}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Created</label>
                        <p class="font-bold">${new Date(reconcileCase.createdDate).toLocaleDateString()}</p>
                    </div>
                    <div class="col-span-2">
                        <label class="text-sm text-gray-600">Description</label>
                        <p>${reconcileCase.description}</p>
                    </div>
                </div>
            `;
            document.getElementById('caseInfo').innerHTML = infoHtml;

            document.getElementById('investigationSection').style.display = ['pending', 'investigation'].includes(reconcileCase.status) ? 'block' : 'none';
            document.getElementById('adjustmentSection').style.display = ['investigation', 'awaiting-approval'].includes(reconcileCase.status) ? 'block' : 'none';
            document.getElementById('approvalSection').style.display = ['awaiting-approval'].includes(reconcileCase.status) ? 'block' : 'none';

            const notesHtml = reconcileCase.investigationNotes.map(note => `
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <div class="text-sm text-gray-600">${note.date} - ${note.author}</div>
                    <p>${note.text}</p>
                </div>
            `).join('');
            document.getElementById('notesList').innerHTML = notesHtml || '<p class="text-gray-500">No notes yet</p>';

            const adjustmentsHtml = reconcileCase.adjustmentProposals.map(adj => `
                <div class="bg-purple-50 p-3 rounded border border-purple-200">
                    <div class="flex justify-between">
                        <strong>₦${adj.amount.toLocaleString()} - ${adj.type}</strong>
                        <span class="badge-status approval-${adj.status}">${adj.status}</span>
                    </div>
                    <p class="text-sm mt-1">${adj.justification}</p>
                </div>
            `).join('');
            document.getElementById('adjustmentsList').innerHTML = adjustmentsHtml || '<p class="text-gray-500">No proposals yet</p>';

            const approvalHtml = Object.entries(reconcileCase.approvals).map(([approver, status]) => `
                <span class="approval-badge approval-${status}">${approver}: ${status}</span>
            `).join('');
            document.getElementById('approvalStatus').innerHTML = approvalHtml || '<p class="text-gray-500">No approvals yet</p>';

            const isApprover = financeDb.currentUser === 'admin' || (financeDb.currentUser === 'Finance' && !reconcileCase.approvals[financeDb.currentUser]);
            document.getElementById('btnApprove').style.display = reconcileCase.status === 'awaiting-approval' && isApprover ? 'block' : 'none';
            document.getElementById('btnReject').style.display = reconcileCase.status === 'awaiting-approval' && isApprover ? 'block' : 'none';

            const trailHtml = reconcileCase.auditTrail.map(entry => `
                <div class="timeline-item">
                    <div class="timeline-item-time">${new Date(entry.timestamp).toLocaleString()}</div>
                    <div class="timeline-item-action">${entry.action}</div>
                    <div class="text-sm text-gray-600">${entry.user} ${entry.details ? '- ' + entry.details : ''}</div>
                </div>
            `).join('');
            document.getElementById('auditTrail').innerHTML = trailHtml;

            window.currentCase = reconcileCase;
            modal.classList.add('active');
        }

        function closeCaseModal() {
            document.getElementById('caseModal').classList.remove('active');
            window.currentCase = null;
        }

        function filterCases() {
            const searchTerm = document.getElementById('searchCases').value.toLowerCase();
            const filtered = financeDb.cases.filter(c => c.caseId.toLowerCase().includes(searchTerm));
            displayCases(filtered);
        }

        function displayCases(cases = financeDb.cases) {
            const html = cases.map(c => `
                <div class="case-card">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">${c.caseId}</h4>
                            <p class="text-sm text-gray-600">${c.description}</p>
                        </div>
                        <span class="badge-status status-${c.status}">${c.status}</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-sm mb-3">
                        <div>
                            <label class="text-gray-600">Source</label>
                            <p>${c.source}</p>
                        </div>
                        <div>
                            <label class="text-gray-600">Amount</label>
                            <p>₦${c.amount.toLocaleString()}</p>
                        </div>
                        <div>
                            <label class="text-gray-600">Severity</label>
                            <p><span class="severity-${c.severity}">${c.severity}</span></p>
                        </div>
                        <div>
                            <label class="text-gray-600">Created</label>
                            <p>${new Date(c.createdDate).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <button onclick="showCaseDetail('${c.caseId}')" class="w-full bg-teal-600 text-white px-3 py-2 rounded hover:bg-teal-700 text-sm">
                        View Details & Manage
                    </button>
                </div>
            `).join('');
            document.getElementById('casesList').innerHTML = html || '<p class="text-gray-500">No cases found</p>';
        }

        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function handleSourceChange() {
            const source = document.getElementById('importSource').value;
            document.getElementById('csvUploadDiv').style.display = source === 'csv' ? 'block' : 'none';
        }

        function executeImport() {
            const source = document.getElementById('importSource').value;
            if (!source) {
                alert('Please select a source');
                return;
            }

            const importedCount = Math.floor(Math.random() * 20) + 5;
            alert('Imported ' + importedCount + ' transactions from ' + source);
            closeImportModal();
            document.getElementById('importSource').value = '';
        }

        function autoDetectDiscrepancies() {
            const sources = ['core-banking', 'pos', 'atm', 'csv'];
            const createdCount = Math.floor(Math.random() * 10) + 3;

            for (let i = 0; i < createdCount; i++) {
                const newCase = new ReconciliationCase();
                newCase.source = sources[Math.floor(Math.random() * sources.length)];
                newCase.description = 'Auto-detected discrepancy in ' + newCase.source;
                newCase.amount = Math.random() * 500000;
                newCase.severity = newCase.amount > 100000 ? 'high' : newCase.amount > 10000 ? 'medium' : 'low';
                financeDb.cases.push(newCase);
            }

            saveFinanceData();
            refreshDashboard();
            alert('Auto-detected and created ' + createdCount + ' cases');
        }

        function addInvestigationNote() {
            if (!window.currentCase) return;

            const noteText = document.getElementById('investigationNotes').value;
            if (!noteText) {
                alert('Please enter a note');
                return;
            }

            window.currentCase.investigationNotes.push({
                date: new Date().toLocaleString(),
                author: financeDb.currentUser,
                text: noteText
            });

            window.currentCase.addAuditEntry('Investigation note added', financeDb.currentUser, noteText.substring(0, 50));
            window.currentCase.status = 'investigation';

            document.getElementById('investigationNotes').value = '';
            saveFinanceData();
            showCaseDetail(window.currentCase.caseId);
        }

        function submitAdjustment() {
            if (!window.currentCase) return;

            const amount = parseFloat(document.getElementById('adjustmentAmount').value);
            const type = document.getElementById('adjustmentType').value;
            const justification = document.getElementById('adjustmentJustification').value;

            if (!amount || !justification) {
                alert('Please fill all fields');
                return;
            }

            window.currentCase.adjustmentProposals.push({
                amount: amount,
                type: type,
                justification: justification,
                submittedBy: financeDb.currentUser,
                submittedDate: new Date().toLocaleString(),
                status: 'pending'
            });

            window.currentCase.status = 'awaiting-approval';
            window.currentCase.addAuditEntry('Adjustment proposal submitted', financeDb.currentUser, '₦' + amount.toLocaleString());

            document.getElementById('adjustmentAmount').value = '';
            document.getElementById('adjustmentJustification').value = '';

            saveFinanceData();
            showCaseDetail(window.currentCase.caseId);
        }

        function approveCase() {
            if (!window.currentCase) return;

            window.currentCase.approvals[financeDb.currentUser] = 'approved';
            window.currentCase.status = 'approved';
            window.currentCase.adjustmentProposals.forEach(adj => adj.status = 'approved');
            window.currentCase.addAuditEntry('Case approved', financeDb.currentUser);

            saveFinanceData();
            alert('Case approved successfully');
            closeCaseModal();
            refreshDashboard();
        }

        function rejectCase() {
            if (!window.currentCase) return;

            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            window.currentCase.approvals[financeDb.currentUser] = 'rejected';
            window.currentCase.status = 'rejected';
            window.currentCase.addAuditEntry('Case rejected', financeDb.currentUser, reason);

            saveFinanceData();
            alert('Case rejected');
            closeCaseModal();
            refreshDashboard();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');

            if (tabName === 'tab-all-cases') {
                displayCases();
            } else if (tabName === 'tab-awaiting-me') {
                const awaiting = financeDb.cases.filter(c => c.status === 'awaiting-approval');
                const html = awaiting.length > 0 ? awaiting.map(c => `
                    <div class="case-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold">${c.caseId} - ${c.description}</h4>
                                <p class="text-sm">Amount: ₦${c.amount.toLocaleString()}</p>
                            </div>
                            <span class="badge-status status-${c.status}">${c.status}</span>
                        </div>
                        <button onclick="showCaseDetail('${c.caseId}')" class="w-full bg-teal-600 text-white px-3 py-2 rounded hover:bg-teal-700 text-sm">
                            Review & Approve
                        </button>
                    </div>
                `).join('') : '<p class="text-gray-500">No cases awaiting your approval</p>';
                document.getElementById('awaitingMeList').innerHTML = html;
            } else if (tabName === 'tab-assigned') {
                const assigned = financeDb.cases.filter(c => c.assignedTo === financeDb.currentUser);
                const html = assigned.length > 0 ? assigned.map(c => `
                    <div class="case-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold">${c.caseId}</h4>
                                <p class="text-sm">${c.description}</p>
                            </div>
                            <span class="badge-status status-${c.status}">${c.status}</span>
                        </div>
                        <button onclick="showCaseDetail('${c.caseId}')" class="w-full bg-teal-600 text-white px-3 py-2 rounded hover:bg-teal-700 text-sm">
                            Investigate
                        </button>
                    </div>
                `).join('') : '<p class="text-gray-500">No cases assigned to you</p>';
                document.getElementById('assignedToMeList').innerHTML = html;
            }
        }

        function refreshDashboard() {
            document.getElementById('statPending').textContent = financeDb.cases.filter(c => c.status === 'pending').length;
            document.getElementById('statInvestigation').textContent = financeDb.cases.filter(c => c.status === 'investigation').length;
            document.getElementById('statAwaitingApproval').textContent = financeDb.cases.filter(c => c.status === 'awaiting-approval').length;
            document.getElementById('statApproved').textContent = financeDb.cases.filter(c => c.status === 'approved').length;
            document.getElementById('statReconciled').textContent = financeDb.cases.filter(c => c.status === 'reconciled').length;

            const now = new Date();
            const aging07 = financeDb.cases.filter(c => {
                const days = (now - new Date(c.createdDate)) / (1000 * 60 * 60 * 24);
                return days >= 0 && days <= 7;
            }).length;
            const aging814 = financeDb.cases.filter(c => {
                const days = (now - new Date(c.createdDate)) / (1000 * 60 * 60 * 24);
                return days > 7 && days <= 14;
            }).length;
            const aging1530 = financeDb.cases.filter(c => {
                const days = (now - new Date(c.createdDate)) / (1000 * 60 * 60 * 24);
                return days > 14 && days <= 30;
            }).length;
            const aging30plus = financeDb.cases.filter(c => {
                const days = (now - new Date(c.createdDate)) / (1000 * 60 * 60 * 24);
                return days > 30;
            }).length;

            document.getElementById('aging0-7').textContent = aging07;
            document.getElementById('aging8-14').textContent = aging814;
            document.getElementById('aging15-30').textContent = aging1530;
            document.getElementById('aging30plus').textContent = aging30plus;

            displayCases();
        }

        function saveFinanceData() {
            localStorage.setItem('financeData', JSON.stringify(financeDb));
        }

        function loadFinanceData() {
            const data = localStorage.getItem('financeData');
            if (data) {
                financeDb = JSON.parse(data);
            }
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.getAttribute('href') === 'finance.html') {
                item.classList.add('active');
            }
        });

        // Logout
        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('userDept');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>