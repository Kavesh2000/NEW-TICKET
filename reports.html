<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Bank System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #F8FAFC;
            min-height: 100vh;
        }
    </style>
    <style>[data-module]:not(.visible){display:none !important;}</style>
</head>
<body class="text-gray-800">
    <header class="bg-blue-900 py-4">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-white">Reports & Analytics</h1>
            <nav class="mt-4">
                <a href="index.html" class="mr-4 hover:underline text-white">Home</a>
                <a href="#" id="logout" class="hover:underline text-white">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Access Control -->
        <div id="accessDenied" class="hidden text-center py-12">
            <i class="fas fa-lock text-6xl text-red-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Access Denied</h2>
            <p class="text-gray-600">Reports & Analytics is available for authorized departments only.</p>
            <p class="text-gray-600">For assistance, contact <a href="mailto:automation@maishabank.com" class="text-teal-600 hover:underline">automation@maishabank.com</a></p>
            <a href="system.html" class="mt-4 inline-block bg-teal-600 text-white px-6 py-2 rounded-lg">Back to Dashboard</a>
        </div>

        <div id="reportsContent">
        <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Analytics Dashboard</h2>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-gray-900">SLA Compliance</h3>
                <p class="text-3xl font-bold text-green-600" id="slaCompliance">--%</p>
                <p class="text-sm text-gray-600">Target: 98%</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-gray-900">Avg Resolution Time</h3>
                <p class="text-3xl font-bold text-blue-600" id="avgResolution">--</p>
                <p class="text-sm text-gray-600">Target: &lt;2h</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-gray-900">Open Tickets</h3>
                <p class="text-3xl font-bold text-amber-600" id="openTickets">0</p>
                <p class="text-sm text-gray-600">By Priority</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md" data-module="finance">
                <h3 class="text-lg font-bold mb-4 text-gray-900">High Value Reconciliations</h3>
                <p class="text-3xl font-bold text-purple-600" id="highValueRec">0</p>
                <p class="text-sm text-gray-600">Adjustments & cases</p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md" data-module="finance">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Reconciliation Aging (0-30+ days)</h3>
                <div id="agingStats" class="space-y-2 text-sm text-gray-700"></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Branch / Channel Performance</h3>
                <div id="branchHeatmap" class="text-sm text-gray-700">Placeholder heatmap â€” aggregated metrics from tickets and cases.</div>
            </div>
        </div>

        <div class="text-center">
            <button id="exportReport" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-md font-semibold">Export CSV</button>
        </div>
        </div>
    </main>

    <footer class="bg-blue-900 py-4 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white">&copy; 2026 Onit Microfinance Bank. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        if (!localStorage.getItem('userDept')) { window.location.href = 'index.html'; }
        document.getElementById('logout').addEventListener('click', function(){ localStorage.removeItem('userDept'); window.location.href='index.html'; });

        function computeKPIs(){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const finance = JSON.parse(localStorage.getItem('financeData')||'{}');
            const cases = (finance.cases)||[];

            const open = tickets.filter(t=> t.status && t.status.toLowerCase() === 'open').length;
            document.getElementById('openTickets').textContent = open;

            // SLA compliance simple calc (tickets with slaMet=true)
            const slaMet = tickets.filter(t=>t.slaMet).length;
            const slaPct = tickets.length? Math.round((slaMet / tickets.length)*100) : 0;
            document.getElementById('slaCompliance').textContent = slaPct + '%';

            // avg resolution
            const resolved = tickets.filter(t=>t.resolutionTimeHours);
            const avg = resolved.length? (resolved.reduce((s,t)=>s+(t.resolutionTimeHours||0),0)/resolved.length).toFixed(1) : '--';
            document.getElementById('avgResolution').textContent = avg + (avg==='--'?'':'h');

            // high value reconciliations
            const hv = cases.filter(c=>c.amount && c.amount > 100000).length;
            document.getElementById('highValueRec').textContent = hv;

            // aging
            const now = new Date();
            const ages = { '0-7':0,'8-14':0,'15-30':0,'30+':0 };
            cases.forEach(c=>{ const days = Math.floor((now - new Date(c.createdDate))/(1000*60*60*24)); if(days<=7) ages['0-7']++; else if(days<=14) ages['8-14']++; else if(days<=30) ages['15-30']++; else ages['30+']++; });
            document.getElementById('agingStats').innerHTML = Object.entries(ages).map(k=>`<div class="flex justify-between"><span>${k[0]}</span><strong>${k[1]}</strong></div>`).join('');
        }

        document.getElementById('exportReport').addEventListener('click', ()=>{
            // Export summary CSV
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const rows = ['id,status,priority,slaMet,resolutionHours', ...tickets.map(t=>`${t.id||''},${t.status||''},${t.priority||''},${!!t.slaMet},${t.resolutionTimeHours||''}`)].join('\n');
            const blob = new Blob([rows], { type:'text/csv' }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='report_summary.csv'; a.click(); URL.revokeObjectURL(url);
        });

        computeKPIs();
        // Check access
        if (!localStorage.getItem('userDept') || !hasModuleAccess('reporting','read')) {
            document.getElementById('accessDenied').classList.remove('hidden');
            document.getElementById('reportsContent').classList.add('hidden');
        } else {
            document.getElementById('accessDenied').classList.add('hidden');
            document.getElementById('reportsContent').classList.remove('hidden');
            document.getElementById('reportsContent').classList.add('visible');
        }
        document.getElementById('logout').addEventListener('click', function(){ localStorage.removeItem('userDept'); window.location.href='index.html'; });