<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit & Compliance - Bank System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #F8FAFC;
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-gray-800">
    <header class="bg-blue-900 py-4">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-white">Audit & Compliance Module</h1>
            <nav class="mt-4">
                <a href="index.html" class="mr-4 hover:underline text-white">Home</a>
                <a href="#" id="logout" class="hover:underline text-white">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Access Control -->
        <div id="accessDenied" class="hidden text-center py-12">
            <i class="fas fa-lock text-6xl text-red-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Access Denied</h2>
            <p class="text-gray-600">Audit & Compliance is available for authorized departments only.</p>
            <p class="text-gray-600">For assistance, contact <a href="mailto:automation@maishabank.com" class="text-teal-600 hover:underline">automation@maishabank.com</a></p>
            <a href="system.html" class="mt-4 inline-block bg-teal-600 text-white px-6 py-2 rounded-lg">Back to Dashboard</a>
        </div>

        <div id="auditContent">
        <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Audit Logs & Compliance</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-4">
            <input id="filterUser" placeholder="Filter by user" class="px-3 py-2 border rounded-md">
            <input id="filterModule" placeholder="Filter by module" class="px-3 py-2 border rounded-md">
            <div class="flex gap-2">
                <input id="fromDate" type="date" class="px-3 py-2 border rounded-md">
                <input id="toDate" type="date" class="px-3 py-2 border rounded-md">
            </div>
        </div>

        <div class="flex gap-2 mb-6">
            <button id="btnSearchAudit" class="bg-teal-600 text-white px-4 py-2 rounded">Search</button>
            <button id="btnExportAudit" class="bg-gray-200 px-4 py-2 rounded">Export CSV</button>
            <button id="btnClearAudit" class="bg-red-500 text-white px-4 py-2 rounded">Clear Logs</button>
        </div>

        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Total Logs</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalLogs">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Critical Actions</h3>
                <p class="text-3xl font-bold text-red-600" id="criticalLogs">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Unique Users</h3>
                <p class="text-3xl font-bold text-amber-600" id="uniqueUsers">0</p>
            </div>
        </div>

        <div id="auditContainer" class="space-y-4">
            <!-- Audit logs will be loaded here -->
        </div>
        <p id="noAudit" class="text-center mt-8 text-gray-700">No audit logs found.</p>
        </div>
    </main>

    <footer class="bg-blue-900 py-4 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white">&copy; 2026 Onit Microfinance Bank. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Check access
        const userDept = localStorage.getItem('userDept');
        if (!userDept || !hasModuleAccess('audit','read')) {
            document.getElementById('accessDenied').classList.remove('hidden');
            document.getElementById('auditContent').classList.add('hidden');
        } else {
            document.getElementById('accessDenied').classList.add('hidden');
            document.getElementById('auditContent').classList.remove('hidden');
        }
        document.getElementById('logout').addEventListener('click', function(){ localStorage.removeItem('userDept'); window.location.href='index.html'; });

        function loadAudit(){ return JSON.parse(localStorage.getItem('auditLogs')||'[]'); }
        function saveAudit(list){ localStorage.setItem('auditLogs', JSON.stringify(list)); }

        function formatRow(log){
            return `
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold">${log.action}</div>
                            <div class="text-sm text-gray-600">Module: ${log.module || 'N/A'} â€¢ User: ${log.user}</div>
                            <div class="text-sm text-gray-500">${log.details||''}</div>
                        </div>
                        <div class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            `;
        }

        function renderAudit(filters={}){
            const all = loadAudit();
            let list = all.slice();
            if(filters.user) list = list.filter(l=> (l.user||'').toLowerCase().includes(filters.user.toLowerCase()));
            if(filters.module) list = list.filter(l=> (l.module||'').toLowerCase().includes(filters.module.toLowerCase()));
            if(filters.from){ list = list.filter(l=> new Date(l.timestamp) >= new Date(filters.from)); }
            if(filters.to){ list = list.filter(l=> new Date(l.timestamp) <= new Date(filters.to)); }

            const container = document.getElementById('auditContainer');
            if(!list.length){ document.getElementById('noAudit').style.display='block'; container.innerHTML=''; }
            else{ document.getElementById('noAudit').style.display='none'; container.innerHTML = list.slice(0,200).map(formatRow).join(''); }

            document.getElementById('totalLogs').textContent = all.length;
            document.getElementById('criticalLogs').textContent = all.filter(l=>/(delete|rejected|unauthori|breach)/i.test(l.action)).length;
            document.getElementById('uniqueUsers').textContent = Array.from(new Set(all.map(l=>l.user))).length;
        }

        document.getElementById('btnSearchAudit').addEventListener('click', ()=>{
            renderAudit({ user: document.getElementById('filterUser').value, module: document.getElementById('filterModule').value, from: document.getElementById('fromDate').value, to: document.getElementById('toDate').value });
        });

        document.getElementById('btnExportAudit').addEventListener('click', ()=>{
            const rows = loadAudit();
            if(!rows.length){ alert('No logs to export'); return; }
            const csv = ['timestamp,module,action,user,details', ...rows.map(r=>`${r.timestamp},"${r.module||''}","${r.action}","${r.user}","${(r.details||'').replace(/"/g,'""')}"`)].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='audit_logs.csv'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('btnClearAudit').addEventListener('click', ()=>{
            if(!confirm('Clear all audit logs? This cannot be undone.')) return; saveAudit([]); renderAudit({});
            alert('Audit logs cleared');
        });

        // initial render
        renderAudit({});
    </script>
</body>
</html>