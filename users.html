<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User & Role Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="modern-ui.css">
    <style>[data-module]:not(.visible){display:none !important;}</style>
    <style>
        body { background: #F8FAFC; }
    </style>
</head>
<body class="text-gray-800">
    <header class="bg-blue-900 py-4">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-white">User & Role Management</h1>
            <div>
                <button id="logout" class="text-white hover:underline">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8" data-module="users">
        <!-- Access Control -->
        <div id="accessDenied" class="hidden text-center py-12">
            <i class="fas fa-lock text-6xl text-red-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Access Denied</h2>
            <p class="text-gray-600">Users & Roles management is available for administrators and IT/ICT department only.</p>
            <p class="text-gray-600">For assistance, contact <a href="mailto:automation@maishabank.com" class="text-teal-600 hover:underline">automation@maishabank.com</a></p>
            <a href="system.html" class="mt-4 inline-block bg-teal-600 text-white px-6 py-2 rounded-lg">Back to Dashboard</a>
        </div>

        <div id="usersContent" data-module="users">
            <h2 class="text-3xl font-bold">Users & Roles</h2>
            <div class="flex gap-2 mb-6">
                <button id="btnExportUsers" class="bg-gray-200 px-3 py-2 rounded">Export CSV</button>
                <button id="btnAddUser" class="bg-teal-600 text-white px-4 py-2 rounded">Create User</button>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-lg p-4">
                    <input id="searchUser" placeholder="Search by name or email" class="w-full px-3 py-2 border rounded mb-4">
                    <div id="usersList" class="space-y-4"></div>
                </div>

                <div class="bg-white rounded-lg p-4">
                    <h3 class="font-bold mb-3">Quick Actions</h3>
                    <button id="btnResetMFA" class="w-full bg-yellow-500 text-white px-3 py-2 rounded mb-2">Reset MFA for Selected</button>
                    <button id="btnSendInvite" class="w-full bg-blue-600 text-white px-3 py-2 rounded">Send Invite</button>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-white rounded-lg p-4" data-module="users">
            <h4 class="font-bold mb-3">Login History (Recent)</h4>
            <div id="loginHistory" class="text-sm text-gray-700"></div>
        </div>
        </div>
    </main>

    <footer class="bg-blue-900 py-4 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white">&copy; 2026 Onit Microfinance Bank. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
            // Check access
            const _dept_users = localStorage.getItem('userDept');
            if (!_dept_users || !hasModuleAccess('users','read')) {
                document.getElementById('accessDenied').classList.remove('hidden');
                document.getElementById('usersContent').classList.add('hidden');
            } else {
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('usersContent').classList.remove('hidden');
                document.getElementById('usersContent').classList.add('visible');
                document.querySelector('main').classList.add('visible');
            }

        // Simple client-side User & Role Management
        const STORAGE_USERS = 'users';
        const STORAGE_AUDIT = 'auditLogs';

        function audit(action, module='Users', user='system', details=''){
            const logs = JSON.parse(localStorage.getItem(STORAGE_AUDIT)||'[]');
            logs.unshift({ timestamp: new Date().toISOString(), module, action, user, details });
            localStorage.setItem(STORAGE_AUDIT, JSON.stringify(logs));
        }

        function loadUsers(){ return JSON.parse(localStorage.getItem(STORAGE_USERS)||'[]'); }
        function saveUsers(u){ localStorage.setItem(STORAGE_USERS, JSON.stringify(u)); }

        function renderUsers(filter=''){
            const container = document.getElementById('usersList');
            const users = loadUsers().filter(u => (u.name+u.email).toLowerCase().includes(filter.toLowerCase()));
            
            // Group users by department/role
            const departments = {};
            users.forEach(u => {
                const dept = u.role || 'Unassigned';
                if (!departments[dept]) departments[dept] = [];
                departments[dept].push(u);
            });
            
            if(!users.length){ 
                container.innerHTML='<p class="text-gray-500">No users found</p>'; 
                return; 
            }
            
            container.innerHTML = Object.keys(departments).sort().map(dept => `
                <div class="department-section">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">${dept} Department (${departments[dept].length} users)</h3>
                    <div class="space-y-2">
                        ${departments[dept].map(u=>`
                            <div class="p-3 border rounded flex items-center justify-between bg-gray-50">
                                <div>
                                    <div class="font-bold">${u.name}</div>
                                    <div class="text-sm text-gray-600">${u.email}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded text-sm" data-id="${u.id}">Edit</button>
                                    <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded text-sm" data-id="${u.id}">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.edit-btn').forEach(b=>b.addEventListener('click', ()=>openEditUser(b.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(b=>b.addEventListener('click', ()=>deleteUser(b.dataset.id)));
        }

        function openEditUser(id){
            const users = loadUsers(); const u = users.find(x=>x.id===id); if(!u) return;
            const name = prompt('Name', u.name); if(name===null) return; const email = prompt('Email', u.email); if(email===null) return;
            const departments = ['IT', 'IT / ICT', 'Finance', 'Operations', 'Risk & Compliance', 'Internal Audit', 'Customer Service', 'Management', 'Security', 'Data Analysis', 'admin'];
            const role = prompt('Department: ' + departments.join(', '), u.role) || u.role;
            if (!departments.includes(role)) { alert('Invalid department. Please choose from: ' + departments.join(', ')); return; }
            u.name = name; u.email = email; u.role = role; saveUsers(users); audit('User edited','Users','system',u.id); renderUsers(document.getElementById('searchUser').value);
        }

        function deleteUser(id){ if(!confirm('Delete user?')) return; let users = loadUsers(); users = users.filter(u=>u.id!==id); saveUsers(users); audit('User deleted','Users','system',id); renderUsers(document.getElementById('searchUser').value); }

        function createUser(){
            const name = prompt('Full name'); if(!name) return; const email = prompt('Email'); if(!email) return;
            const departments = ['IT', 'IT / ICT', 'Finance', 'Operations', 'Risk & Compliance', 'Internal Audit', 'Customer Service', 'Management', 'Security', 'Data Analysis', 'admin'];
            const role = prompt('Department: ' + departments.join(', '),'Finance') || 'Finance';
            if (!departments.includes(role)) { alert('Invalid department. Please choose from: ' + departments.join(', ')); return; }
            const users = loadUsers(); const id = 'U-'+Date.now().toString(36).toUpperCase().slice(-6);
            users.unshift({ id, name, email, role, mfa: false, sso: false, created: new Date().toISOString() }); saveUsers(users); audit('User created','Users','system',id); renderUsers('');
        }

        function exportUsersCSV(){
            const users = loadUsers(); if(!users.length){ alert('No users to export'); return; }
            const csv = ['id,name,email,role,mfa,sso,created', ...users.map(u=>`${u.id},"${u.name}",${u.email},${u.role},${u.mfa},${u.sso},${u.created}`)].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url);
        }

        function loadLoginHistory(){ const logs = JSON.parse(localStorage.getItem('loginHistory')||'[]'); const el = document.getElementById('loginHistory'); if(!logs.length){ el.innerHTML='<p class="text-gray-500">No login records</p>'; return; } el.innerHTML = logs.slice(0,20).map(l=>`<div class="border-b py-2"><strong>${l.user}</strong> - ${new Date(l.time).toLocaleString()} - ${l.ip||'N/A'}</div>`).join(''); }

        document.getElementById('btnAddUser').addEventListener('click', createUser);
        document.getElementById('btnExportUsers').addEventListener('click', exportUsersCSV);
        document.getElementById('searchUser').addEventListener('input', e=>renderUsers(e.target.value));

        // Logout
        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('userDept');
            window.location.href = 'index.html';
        });

        // seed if empty
        (function seed(){
            if(!loadUsers().length){
                const initialUsers = [
                    // IT Department
                    { id: 'U-IT001', name: 'Stevaniah Kavela', email: 'stevaniah.kavela@maishabank.com', role: 'IT', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-IT002', name: 'Mercy Mukhwana', email: 'mercy.mukhwana@maishabank.com', role: 'IT', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-IT003', name: 'Eric Mokaya', email: 'eric.mokaya@maishabank.com', role: 'IT', mfa: false, sso: false, created: new Date().toISOString() },
                    
                    // Operations Department
                    { id: 'U-OPS001', name: 'Caroline Ngugi', email: 'caroline.ngugi@maishabank.com', role: 'Operations', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-OPS002', name: 'Lilian Kimani', email: 'lilian.kimani@maishabank.com', role: 'Operations', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-OPS003', name: 'Maureen Kerubo', email: 'maureen.kerubo@maishabank.com', role: 'Operations', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-OPS004', name: 'Alice Muthoni', email: 'alice.muthoni@maishabank.com', role: 'Operations', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-OPS005', name: 'Michael Mureithi', email: 'michael.mureithi@maishabank.com', role: 'Operations', mfa: false, sso: false, created: new Date().toISOString() },
                    
                    // Finance Department
                    { id: 'U-FIN001', name: 'Patrick Ndegwa', email: 'patrick.ndegwa@maishabank.com', role: 'Finance', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-FIN002', name: 'Margaret Njeri', email: 'margaret.njeri@maishabank.com', role: 'Finance', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-FIN003', name: 'Elizabeth Mungai', email: 'elizabeth.mungai@maishabank.com', role: 'Finance', mfa: false, sso: false, created: new Date().toISOString() },
                    
                    // Data Analysis Department
                    { id: 'U-DA001', name: 'Stevaniah Kavela', email: 'stevaniah.kavela@maishabank.com', role: 'Data Analysis', mfa: false, sso: false, created: new Date().toISOString() },
                    
                    // Customer Service Department
                    { id: 'U-CS001', name: 'Ebby Gesare', email: 'ebby.gesare@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS002', name: 'Vivian Orisa', email: 'vivian.orisa@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS003', name: 'Juliana Jeptoo', email: 'juliana.jeptoo@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS004', name: 'Faith Bonareri', email: 'faith.bonareri@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS005', name: 'Patience Mutunga', email: 'patience.mutunga@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS006', name: 'Eva Mukami', email: 'eva.mukami@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-CS007', name: 'Peter Kariuki', email: 'peter.kariuki@maishabank.com', role: 'Customer Service', mfa: false, sso: false, created: new Date().toISOString() },
                    
                    // Admin Department
                    { id: 'U-ADM001', name: 'Elizabeth Mungai', email: 'elizabeth.mungai@maishabank.com', role: 'admin', mfa: true, sso: true, created: new Date().toISOString() },
                    { id: 'U-ADM002', name: 'Ken Okwero', email: 'ken.okwero@maishabank.com', role: 'admin', mfa: true, sso: true, created: new Date().toISOString() },
                    { id: 'U-ADM003', name: 'Alice Muthoni', email: 'alice.muthoni@maishabank.com', role: 'admin', mfa: true, sso: true, created: new Date().toISOString() },
                    
                    // Security Department
                    { id: 'U-SEC001', name: 'Bonface Kioko', email: 'bonface.kioko@maishabank.com', role: 'Security', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-SEC002', name: 'Eric Mokaya', email: 'eric.mokaya@maishabank.com', role: 'Security', mfa: false, sso: false, created: new Date().toISOString() },
                    { id: 'U-SEC003', name: 'Clive Odame', email: 'clive.odame@maishabank.com', role: 'Security', mfa: false, sso: false, created: new Date().toISOString() }
                ];
                
                saveUsers(initialUsers);
                audit('Initial user database seeded with correct assignments','Users','system','all-users');
            }
            renderUsers(''); 
            loadLoginHistory(); 
        })();
    </script>
</body>
</html>